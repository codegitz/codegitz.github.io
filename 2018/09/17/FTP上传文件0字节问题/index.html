<!DOCTYPE html>
<html class="full-height">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//cdn.bootcss.com/bulma/0.4.1/css/bulma.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  
  <title>FTP上传文件0字节问题 | Codegitz&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="FTP上传文件0字节问题这几天在做一个ftp图片服务器，使用的是vsftp客户端，按照一套流程下来，基本搭建完毕，在Windows窗口上传文件正常，但是到了在Java程序中就出现了问题，上传图片的时候并不会报错，而是会卡住大概30秒左右，接着返回false，并不会抛出异常。一开始在想会不会是服务器没搭好，但是逐步排查下来，并没有发现问题，并且如果是服务器本身出现了问题，那么Windows命令行也">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="FTP上传文件0字节问题">
<meta property="og:url" content="http://yoursite.com/2018/09/17/FTP上传文件0字节问题/index.html">
<meta property="og:site_name" content="Codegitz&#39;s Blog">
<meta property="og:description" content="FTP上传文件0字节问题这几天在做一个ftp图片服务器，使用的是vsftp客户端，按照一套流程下来，基本搭建完毕，在Windows窗口上传文件正常，但是到了在Java程序中就出现了问题，上传图片的时候并不会报错，而是会卡住大概30秒左右，接着返回false，并不会抛出异常。一开始在想会不会是服务器没搭好，但是逐步排查下来，并没有发现问题，并且如果是服务器本身出现了问题，那么Windows命令行也">
<meta property="og:image" content="https://i.imgur.com/3aIgoOX.png">
<meta property="og:image" content="https://i.imgur.com/rWim9yo.png">
<meta property="og:updated_time" content="2018-09-16T17:37:34.003Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FTP上传文件0字节问题">
<meta name="twitter:description" content="FTP上传文件0字节问题这几天在做一个ftp图片服务器，使用的是vsftp客户端，按照一套流程下来，基本搭建完毕，在Windows窗口上传文件正常，但是到了在Java程序中就出现了问题，上传图片的时候并不会报错，而是会卡住大概30秒左右，接着返回false，并不会抛出异常。一开始在想会不会是服务器没搭好，但是逐步排查下来，并没有发现问题，并且如果是服务器本身出现了问题，那么Windows命令行也">
<meta name="twitter:image" content="https://i.imgur.com/3aIgoOX.png">
  
    <link rel="alternate" href="/atom.xml" title="Codegitz&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="https://raw.githubusercontent.com/codegitz/TestCapacity/7acf45f27b3185ef97e94f69889d4c0253b12723/a5ea21%5B1%5D.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/nav.css">
<link rel="stylesheet" href="/css/layout.css">
  

</head>

<body>
  <header id="navbar" class="overflow-hidden">
  <div class="container">
    <nav class="nav">
         <div class="nav-left">
            <a href="/" class="nav-item" style="font-size: 20px;">
              <span class="logo">Codegitz</span>'s Blog
            </a>
         </div>
        <div class="nav-center is-hidden position-relative" id="search_container">
            <div class="nav-item full-width full-height">
                <i class="fa fa-search has-padding" aria-hidden="true"></i>
                <input type="text" id="search_input" class="search-input full-height full-width" placeholder="Search post" autofocus>
                <i id="close_search" class="fa fa-times" aria-hidden="true"></i>
            </div>
            <div id="search_result"></div>
        </div>
        <div class="nav-right nav-menu">
            <a class="nav-item" id="search">
                <i class="fa fa-search" aria-hidden="true"></i>
            </a>
            
            <a class="nav-item" href="/home">
                Home
            </a>
            
            <a class="nav-item" href="/works">
                My Works
            </a>
            
            <a class="nav-item" href="/about">
                About
            </a>
            
        </div>
        <span class="nav-toggle" id="navMenuDropdown">
            <span></span>
            <span></span>
            <span></span>
        </span>
        <div class="navbar-menu position-absolute full-width content-box is-hidden-desktop is-flex flex-column center" style="top: 100%;">
            
            <a class="nav-item flex-1" href="/home">
                Home
            </a>
            
            <a class="nav-item flex-1" href="/works">
                My Works
            </a>
            
            <a class="nav-item flex-1" href="/about">
                About
            </a>
            
        </div>
    </nav>
  </div>
</header>

  <div id="main-wrap" class="position-relative" style="margin-top: 55px;">
      <div class="main-inner-content">
          <!--博文页面-->

<style>
    .header-box {
        height: 370px;
        filter: blur(10px);
        background-size: cover;
        background-color: lightsteelblue;
    }

    .post-box {
        padding: 15px;
        padding-top: 60px;
        min-height: 80vh;
        margin-top: -200px;
        border-radius: 4px;
        background-color: rgba(255,255,255,.8);
    }

    .post-avatar {
        height: 30px;
        width: 30px;
        border-radius: 50%;
    }

    .flow-chart {
        text-align: center;
    }

    img[alt="post-cover"] {
        display: none;
    }
</style>
<header>
    <div id="header_box" class="header-box"></div>
</header>
<section>
    <div class="container post-box">
        <div class="content post-title is-flex center flex-column" style="margin-bottom: 70px; overflow: auto;">
            <h1 class="has-text-centered" style="padding-bottom: 10px; border-bottom: 3px solid #fff">
                <strong>FTP上传文件0字节问题</strong>
            </h1>
            
            <div class="is-flex align-center">
                <img class="post-avatar" src="https://raw.githubusercontent.com/codegitz/MarkdownPhotos/master/Img8049893_f.jpg">
                <span style="padding:0 10px;"> <span class="sub-title">By</span> Codegitz</span>
                <span class="post-date sub-title">at: 2018-09-17</span>
            </div>
            
                <div>
                    
                         <a class="tag is-post-tag" href="/tags/Java/">Java</a>
                    
                </div>
            
        </div>
        <div class="content" style="overflow: auto">
            <script src="/assets/js/APlayer.min.js"> </script><h2 id="FTP上传文件0字节问题"><a href="#FTP上传文件0字节问题" class="headerlink" title="FTP上传文件0字节问题"></a>FTP上传文件0字节问题</h2><p>这几天在做一个ftp图片服务器，使用的是vsftp客户端，按照一套流程下来，基本搭建完毕，在Windows窗口上传文件正常，但是到了在Java程序中就出现了问题，上传图片的时候并不会报错，而是会卡住大概30秒左右，接着返回false，并不会抛出异常。一开始在想会不会是服务器没搭好，但是逐步排查下来，并没有发现问题，并且如果是服务器本身出现了问题，那么Windows命令行也应该不能上传成功，但是窗口上传成功了，说明了服务器的搭建应该是没有问题的。后来怀疑是自己的代码有问题，但是去参考了一番，发现并没有什么异样，十分懵逼。<br><br>然后Google发现这样一个问题：<br><br>VSFTP有两种模式：pasv模式与port模式，也就是我们所说的主动和被动模式<br><br><strong>Port模式:</strong><br><br>当客户端C向服务端S连接后，使用的是Port模式,那么客户端C会发送一条命令告诉服务端S(客户端C在本地打开了一个端口N在等着你进行数据连接),当服务端S收到这个Port命令后 就会向客户端打开的那个端口N进行连接，这种数据连接就生成了。<br><br><strong>Pasv模式:</strong><br><br>当客户端C向服务端S连接后，服务端S会发信息给客户端C,这个信息是(服务端S在本地打开了一个端口M,你现在去连接我吧),当客户端C收到这个信息后，就可以向服务端S的M端口进行连接,连接成功后，数据连接也建立了。<br>从上面的解释中，大家可以看到两种模式主要的不同是数据连接建立的不同，对于Port模式，是客户端C在本地打开一个端口等服务端S去连接建立数据连接；而Pasv模式就是服务端S打开一个端口等待客户端C去建立一个数据连接。<br><br><strong>默认情况下，FTPCLIENT用的是port模式</strong><br><br>参考FTPCLIENT原码<br><br>默认参数设置：<br></p>
<pre><code> //两常量的定义及解释
 /**
 * A constant indicating the FTP session is expecting all transfers
 * to occur between the client (local) and server and that the server
 * should connect to the client&apos;s data port to initiate a data transfer.
 * This is the default data connection mode when and FTPClient instance
 * is created.
 */
 public static final int  ACTIVE_LOCAL_DATA_CONNECTION_MODE = 0;

 /**
 * A constant indicating the FTP session is expecting all transfers
 * to occur between the client (local) and server and that the server
 * is in passive mode, requiring the client to connect to the
 * server&apos;s data port to initiate a transfer.
 */
public static final int PASSIVE_LOCAL_DATA_CONNECTION_MODE = 2;

//默认参数设置
private void __initDefaults()
    {
        //此处定在port模式，ACTIVE_LOCAL_DATA_CONNECTION_MODE
        __dataConnectionMode = ACTIVE_LOCAL_DATA_CONNECTION_MODE;
        __passiveHost        = null;
        __passivePort        = -1;
        __activeExternalHost = null;
        __reportActiveExternalHost = null;
        __activeMinPort = 0;
        __activeMaxPort = 0;
        __fileType           = FTP.ASCII_FILE_TYPE;
        __fileStructure      = FTP.FILE_STRUCTURE;
        __fileFormat         = FTP.NON_PRINT_TEXT_FORMAT;
        __fileTransferMode   = FTP.STREAM_TRANSFER_MODE;
        __restartOffset      = 0;
        __systemName         = null;
        __entryParser        = null;
        __entryParserKey    = &quot;&quot;;
        __featuresMap = null;
    }
</code></pre><p><strong>port模式，即主动模式：</strong><br></p>
<pre><code> /**
 * Set the current data connection mode to
 * &lt;code&gt;ACTIVE_LOCAL_DATA_CONNECTION_MODE&lt;/code&gt;.  No communication
 * with the FTP server is conducted, but this causes all future data
 * transfers to require the FTP server to connect to the client&apos;s
 * data port.  Additionally, to accommodate differences between socket
 * implementations on different platforms, this method causes the
 * client to issue a PORT command before every data transfer.
 */
public void enterLocalActiveMode()
{
    //主动，ACTIVE
    __dataConnectionMode = ACTIVE_LOCAL_DATA_CONNECTION_MODE;
    __passiveHost = null;
    __passivePort = -1;
}
</code></pre><p><strong>pasv模式，即被动模式：</strong><br></p>
<pre><code>/**
 * Set the current data connection mode to
 * &lt;code&gt; PASSIVE_LOCAL_DATA_CONNECTION_MODE &lt;/code&gt;.  Use this
 * method only for data transfers between the client and server.
 * This method causes a PASV (or EPSV) command to be issued to the server
 * before the opening of every data connection, telling the server to
 * open a data port to which the client will connect to conduct
 * data transfers.  The FTPClient will stay in
 * &lt;code&gt; PASSIVE_LOCAL_DATA_CONNECTION_MODE &lt;/code&gt; until the
 * mode is changed by calling some other method such as
 * {@link #enterLocalActiveMode  enterLocalActiveMode() }
 * &lt;p&gt;
 * &lt;b&gt;N.B.&lt;/b&gt; currently calling any connect method will reset the mode to
 * ACTIVE_LOCAL_DATA_CONNECTION_MODE.
 */
public void enterLocalPassiveMode()
{
    //被动，PASSIVE
    __dataConnectionMode = PASSIVE_LOCAL_DATA_CONNECTION_MODE;
    // These will be set when just before a data connection is opened
    // in _openDataConnection_()
    __passiveHost = null;
    __passivePort = -1;
}**
</code></pre><p>想到此处反正是客户端发起的请求，所以改为被动模式，在代码中加入<br></p>
<pre><code>ftpClient.enterLocalPassiveMode();
</code></pre><p>然后再次运行，上传成功。<br><br>测试代码如下：<br></p>
<pre><code>@Test
    public void textFtpClient() throws Exception {
        FTPClient ftpClient = new FTPClient();
        ftpClient.connect(&quot;IP&quot;, 21);
        ftpClient.login(&quot;username&quot;, &quot;password&quot;);
        FileInputStream inputStream = new FileInputStream(new File(&quot;E:\\2073.jpg&quot;));
        System.out.println(inputStream);
        ftpClient.setFileType(FTP.BINARY_FILE_TYPE);
        ftpClient.enterLocalPassiveMode();
        ftpClient.storeFile(&quot;123.jpg&quot;, inputStream);
        inputStream.close();
    ftpClient.logout();
}
</code></pre><p>效果如下：<br><br><img src="https://i.imgur.com/3aIgoOX.png" alt=""></p>
<p>浏览器访问：<br><br><img src="https://i.imgur.com/rWim9yo.png" alt=""></p>
<p>可以正常访问，问题解决。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个问题，应该说是没有留意细节的问题，在一开始的时候就有听到主动与被动模式的设置，但是没有太去在意，所以造成了隐患。<br>下面附上完整的FtpUtil代码：</p>
<pre><code>package com.common.utils;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

import org.apache.commons.net.ftp.FTP;
import org.apache.commons.net.ftp.FTPClient;
import org.apache.commons.net.ftp.FTPFile;
import org.apache.commons.net.ftp.FTPReply;

/**
 * ftp上传下载工具类
 * &lt;p&gt;Title: FtpUtil&lt;/p&gt;
 * &lt;p&gt;Description: &lt;/p&gt;
 * @author    Quan
 * @date    2018年7月29日下午8:11:51
 * @version 1.0
 */
public class FtpUtil {

    /** 
     * Description: 向FTP服务器上传文件 
     * @param host FTP服务器hostname 
     * @param port FTP服务器端口 
     * @param username FTP登录账号 
     * @param password FTP登录密码 
     * @param basePath FTP服务器基础目录
     * @param filePath FTP服务器文件存放路径。例如分日期存放：/2018/01/01。文件的路径为basePath+filePath
     * @param filename 上传到FTP服务器上的文件名 
     * @param input 输入流 
     * @return 成功返回true，否则返回false 
     */  
    public static boolean uploadFile(String host, int port, String username, String password, String basePath,
            String filePath, String filename, InputStream input) {
        boolean result = false;
        FTPClient ftp = new FTPClient();
        try {
            int reply;
            ftp.connect(host, port);// 连接FTP服务器
            // 如果采用默认端口，可以使用ftp.connect(host)的方式直接连接FTP服务器
            ftp.login(username, password);// 登录
            reply = ftp.getReplyCode();
            if (!FTPReply.isPositiveCompletion(reply)) {
                ftp.disconnect();
                return result;
            }
            //切换到上传目录
            if (!ftp.changeWorkingDirectory(basePath+filePath)) {
                //如果目录不存在创建目录
                String[] dirs = filePath.split(&quot;/&quot;);
                String tempPath = basePath;
                for (String dir : dirs) {
                    if (null == dir || &quot;&quot;.equals(dir)) continue;
                    tempPath += &quot;/&quot; + dir;
                    if (!ftp.changeWorkingDirectory(tempPath)) {
                        if (!ftp.makeDirectory(tempPath)) {
                            return result;
                        } else {
                            ftp.changeWorkingDirectory(tempPath);
                        }
                    }
                }
            }
            //设置上传文件的类型为二进制类型
            ftp.setFileType(FTP.BINARY_FILE_TYPE);
            //上传文件
            if (!ftp.storeFile(filename, input)) {
                return result;
            }
            input.close();
            ftp.logout();
            result = true;
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (ftp.isConnected()) {
                try {
                    ftp.disconnect();
                } catch (IOException ioe) {
                }
            }
        }
        return result;
    }

    /** 
     * Description: 从FTP服务器下载文件 
     * @param host FTP服务器hostname 
     * @param port FTP服务器端口 
     * @param username FTP登录账号 
     * @param password FTP登录密码 
     * @param remotePath FTP服务器上的相对路径 
     * @param fileName 要下载的文件名 
     * @param localPath 下载后保存到本地的路径 
     * @return 
     */  
    public static boolean downloadFile(String host, int port, String username, String password, String remotePath,
            String fileName, String localPath) {
        boolean result = false;
        FTPClient ftp = new FTPClient();
        try {
            int reply;
            ftp.connect(host, port);
            // 如果采用默认端口，可以使用ftp.connect(host)的方式直接连接FTP服务器
            ftp.login(username, password);// 登录
            reply = ftp.getReplyCode();
            if (!FTPReply.isPositiveCompletion(reply)) {
                ftp.disconnect();
                return result;
            }
            ftp.changeWorkingDirectory(remotePath);// 转移到FTP服务器目录
            FTPFile[] fs = ftp.listFiles();
            for (FTPFile ff : fs) {
                if (ff.getName().equals(fileName)) {
                    File localFile = new File(localPath + &quot;/&quot; + ff.getName());

                    OutputStream is = new FileOutputStream(localFile);
                    ftp.retrieveFile(ff.getName(), is);
                    is.close();
                }
            }

            ftp.logout();
            result = true;
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (ftp.isConnected()) {
                try {
                    ftp.disconnect();
                } catch (IOException ioe) {
                }
            }
        }
        return result;
    }

    public static void main(String[] args) {
        try {  
            FileInputStream in=new FileInputStream(new File(&quot;E:\\2073.jpg&quot;));  
            boolean flag = uploadFile(&quot;ip&quot;, 21, &quot;ftpuser&quot;, &quot;password&quot;, &quot;/var/www/images&quot;,&quot;/2018/09/16&quot;, &quot;heyhey.jpg&quot;, in);  
            System.out.println(flag);  
        } catch (FileNotFoundException e) {  
            e.printStackTrace();  
        }  
    }
}
</code></pre>
        </div>
        <div class="post-reply">
            
            
        </div>
    </div>
</section>
<script>
    // 获取第一张图, 用以当封面背景图
    var img = document.querySelectorAll('img')[1]

    if (img) {
        var header_box = document.querySelector('#header_box')
        header_box.style.backgroundImage = 'url('+ img.src +')'
    }
</script>
      </div>
  </div>
  <style>
  #footer {
    min-height: 10vh;
    background: black;
    color: #fff;
  }

  #footer a {
    color: #e1e1e1;
  }
</style>
<footer id="footer" class="has-text-centered is-flex center">
  <div class="container has-padding">
    <div>
      <div>
        <!--请您保留作者署名, 主题制作来之不易-->
        Theme by <a href="http://haojen.github.io/">Haojen Ma</a>
        <br>
        Copyright © Codegitz 2018
        <br>
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      </div>
    </div>
  </div>
</footer>

<script src="/js/search_core.js"></script>
<script src="/js/script.js"></script>

</body>
</html>